# Шлюз WMS-Шаттл (Версия 3.0)

Модульный шлюз для взаимодействия между WMS и роботизированными тележками (шаттлами).

## Особенности

- Модульная архитектура с четким разделением ответственности
- Асинхронное взаимодействие с шаттлами и WMS
- Приоритизация команд и управление очередями
- Механизм повторных попыток для обработки временных сбоев
- Хранение состояний в Redis
- Независимость от веб-фреймворков (FastAPI)

## Структура проекта

```
shuttle_gateway_v2/
├── core/                   # Ядро приложения
│   ├── config.py           # Конфигурация
│   └── logging.py          # Логирование
├── shuttle_module/         # Модуль взаимодействия с шаттлами
│   ├── commands.py         # Команды шаттлов
│   ├── shuttle_client.py   # Клиент для взаимодействия с шаттлом
│   ├── shuttle_listener.py # Сервер для прослушивания сообщений от шаттлов
│   ├── shuttle_manager.py  # Менеджер шаттлов
│   └── shuttle_state.py    # Состояние шаттла
├── wms_module/             # Модуль взаимодействия с WMS
│   ├── wms_client.py       # Клиент для взаимодействия с WMS API
│   └── wms_integration.py  # Интеграция с WMS
├── storage_module/         # Модуль хранения данных
│   └── redis_storage.py    # Хранилище данных в Redis
├── utils/                  # Утилиты
│   └── retry.py            # Механизм повторных попыток
├── config.yaml             # Файл конфигурации
└── main.py                 # Точка входа
```

## Установка

1. Установите зависимости:

```bash
pip install -r requirements.txt
```

2. Настройте конфигурацию в файле `config.yaml` или через переменные окружения.

## Запуск

```bash
python main.py --config config.yaml
```

## Конфигурация

Конфигурация может быть задана через файл YAML или переменные окружения:

### Файл конфигурации

```yaml
shuttles:
  shuttle_1:
    host: "10.10.10.10"
    command_port: 2000
    response_port: 5000

stock_to_shuttle:
  Главный:
    - shuttle_1

wms:
  api_url: "http://wms-server/api"
  username: "api_user"
  password: "api_password"
  poll_interval: 60
  webhook_url: "http://wms-server/webhook"

redis:
  host: "localhost"
  port: 6379
  db: 0
  password: null

logging:
  level: "INFO"
  file_path: "logs/gateway.log"

command_queue_max_size: 1000
command_processor_workers: 2
shuttle_listener_port: 8181  # Порт для прослушивания сообщений от шаттлов
```

### Переменные окружения

```
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
REDIS_PASSWORD=

WMS_API_URL=http://wms-server/api
WMS_API_USERNAME=api_user
WMS_API_PASSWORD=api_password
WMS_POLL_INTERVAL=60
WMS_WEBHOOK_URL=http://wms-server/webhook

LOG_LEVEL=INFO
LOG_FILE=logs/gateway.log

COMMAND_QUEUE_MAX_SIZE=1000
COMMAND_PROCESSOR_WORKERS=2
SHUTTLE_LISTENER_PORT=8181
```

## Основные компоненты

### Модуль шаттлов

- `ShuttleClient` - клиент для отправки команд шаттлу через TCP
- `ShuttleListener` - сервер для прослушивания сообщений от шаттлов
- `ShuttleManager` - менеджер для управления шаттлами и очередями команд
- `ShuttleCommand` - команды для шаттлов
- `ShuttleState` - состояние шаттла

### Модуль WMS

- `WmsClient` - клиент для взаимодействия с WMS API
- `WmsIntegration` - интеграция с WMS для получения команд и обновления статусов

### Модуль хранения

- `RedisStorage` - хранилище данных в Redis

## Принцип работы

1. Шлюз запускает TCP-сервер на порту 8181 для прослушивания сообщений от шаттлов
2. Шаттлы подключаются к шлюзу и отправляют сообщения на порт 8181
3. Шлюз отправляет команды шаттлам на их порт 2000
4. Шлюз периодически опрашивает WMS API для получения новых команд
5. Полученные команды преобразуются в команды для шаттлов
6. Команды добавляются в очередь с приоритетом
7. Воркеры обрабатывают команды из очереди и отправляют их шаттлам
8. Шаттлы отправляют ответы, которые обрабатываются шлюзом
9. Статусы выполнения команд отправляются обратно в WMS

## Схема взаимодействия с шаттлами

```
Шлюз (10.181.80.30)                   Шаттл (10.181.80.130)
+------------------+                  +------------------+
|                  |                  |                  |
|  Порт 8181       |<-----------------|  Порт 5000       |  Шаттл отправляет сообщения
|  (слушает)       |                  |  (отправляет)    |  на порт 8181 шлюза
|                  |                  |                  |
|  Отправляет      |----------------->|  Порт 2000       |  Шлюз отправляет команды
|  команды         |                  |  (слушает)       |  на порт 2000 шаттла
|                  |                  |                  |
+------------------+                  +------------------+
```

## Приоритизация команд

Команды имеют следующие приоритеты (меньше = выше):

1. HOME - возврат в домашнюю позицию
2. STATUS - запрос статуса
3. BATTERY - запрос уровня батареи
4. MRCD - подтверждение получения сообщения
5. PALLET_OUT - выгрузка паллеты
6. PALLET_IN - загрузка паллеты
7. STACK_OUT - выгрузка из стека
8. STACK_IN - загрузка в стек
9. FIFO - операция FIFO
10. FILO - операция FILO
11. COUNT - подсчет паллет
12. WDH - запрос часов работы
13. WLH - запрос часов под нагрузкой
## Использование CLI-утилиты

Для управления шаттлами через командную строку можно использовать CLI-утилиту:

```bash
# Отправить команду шаттлу
python cli.py send virtual_shuttle_1 STATUS

# Отправить команду с параметрами
python cli.py send virtual_shuttle_1 FIFO --params 3

# Вывести список доступных шаттлов
python cli.py list

# Получить статус шаттла
python cli.py status virtual_shuttle_1

# Использовать другой файл конфигурации
python cli.py --config /path/to/config.yaml list
```

Доступные команды для шаттлов:
- `PALLET_IN` - загрузка паллеты
- `PALLET_OUT` - выгрузка паллеты
- `FIFO` - операция FIFO (First In, First Out)
- `FILO` - операция FILO (First In, Last Out)
- `STACK_IN` - загрузка в стек
- `STACK_OUT` - выгрузка из стека
- `HOME` - возврат в домашнюю позицию
- `COUNT` - подсчет паллет
- `STATUS` - запрос статуса
- `BATTERY` - запрос уровня батареи
- `WDH` - запрос часов работы
- `WLH` - запрос часов под нагрузкой
- `MRCD` - подтверждение получения сообщения
## Перемещение шаттла между ячейками

Для перемещения шаттла между ячейками можно использовать команду `move` в CLI-утилите:

```bash
# Переместить шаттл из ячейки A1 в ячейку B2 на складе "Главный"
python cli.py move virtual_shuttle_1 A1 B2

# Переместить шаттл из ячейки A1 в ячейку B2 на другом складе
python cli.py move virtual_shuttle_1 A1 B2 --stock "Второй склад"
```

При подключении шаттла шлюз автоматически запрашивает его статус и местоположение. Если шаттл отправляет сообщение `LOCATION=CELL:A1`, шлюз извлекает информацию о текущей ячейке и сохраняет ее в состоянии шаттла.

## Сохранение состояния в Redis

Шлюз автоматически сохраняет состояния шаттлов в Redis с интервалом 10 секунд. При запуске шлюз загружает сохраненные состояния из Redis, что позволяет восстановить информацию о местоположении шаттлов после перезапуска.

Состояние шаттла включает:
- Статус (FREE, BUSY, ERROR и т.д.)
- Текущую команду
- Местоположение
- Уровень батареи
- Текущую ячейку
- Информацию о складе
- Время последней активности